<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Backtester</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #111827;
            color: white;
        }
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="min-h-screen bg-gray-900 text-white p-6">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold mb-2">üöÄ Backtester Crypto</h1>
                <p class="text-gray-400">Testez vos strat√©gies de trading sur les principales cryptomonnaies</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Graphique principal -->
                <div class="lg:col-span-2 bg-gray-800 rounded-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-4">
                            <select 
                                id="cryptoSelect"
                                class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white"
                            >
                                <option value="ethereum">Ethereum (ETH)</option>
                                <option value="solana">Solana (SOL)</option>
                                <option value="cardano">Cardano (ADA)</option>
                                <option value="pepe">Pepe (PEPE)</option>
                                <option value="dogwifcoin">Dogwifhat (WIF)</option>
                            </select>
                            
                            <select 
                                id="timeframeSelect"
                                class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white"
                            >
                                <option value="m1">1m</option>
                                <option value="m5">5m</option>
                                <option value="m15">15m</option>
                                <option value="h1" selected>1h</option>
                                <option value="h4">4h</option>
                                <option value="d1">1d</option>
                            </select>
                            
                            <button
                                id="refreshBtn"
                                class="bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded-lg text-sm"
                            >
                                üîÑ Actualiser
                            </button>
                        </div>
                        
                        <div class="text-right">
                            <div id="currentPrice" class="text-2xl font-bold text-blue-400">
                                $0.00
                            </div>
                            <div id="cryptoLabel" class="text-sm text-gray-400">
                                ETH/USD
                            </div>
                        </div>
                    </div>

                    <div id="errorMessage" class="bg-red-900/20 border border-red-500 rounded-lg p-3 mb-4 hidden">
                        <p class="text-red-400 text-sm" id="errorText"></p>
                        <p class="text-gray-400 text-xs mt-1">Utilisation de donn√©es simul√©es</p>
                    </div>

                    <div id="loadingIndicator" class="flex items-center justify-center h-96 hidden">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                        <span class="ml-3 text-gray-400">Chargement des donn√©es...</span>
                    </div>

                    <div class="chart-container">
                        <canvas id="priceChart"></canvas>
                    </div>
                    
                    <div class="mt-4 text-xs text-gray-500 flex justify-between items-center">
                        <span>üìä Donn√©es fournies par CoinCap API</span>
                        <span id="lastUpdate">Derni√®re mise √† jour: --:--</span>
                    </div>
                </div>

                <!-- Configuration -->
                <div class="bg-gray-800 rounded-lg p-6">
                    <div class="flex items-center mb-4">
                        <h2 class="text-xl font-semibold">‚öôÔ∏è Configuration</h2>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Capital initial ($)</label>
                            <input
                                type="number"
                                id="initialBalance"
                                value="10000"
                                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white"
                            />
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-1">Strat√©gie</label>
                            <select
                                id="strategy"
                                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white"
                            >
                                <option value="sma_crossover">SMA Crossover</option>
                                <option value="rsi_strategy">RSI Strategy</option>
                                <option value="macd_strategy">MACD Strategy</option>
                                <option value="bollinger_bands">Bollinger Bands</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-sm font-medium mb-1">Stop Loss (%)</label>
                                <input
                                    type="number"
                                    id="stopLoss"
                                    value="5"
                                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white"
                                />
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Take Profit (%)</label>
                                <input
                                    type="number"
                                    id="takeProfit"
                                    value="10"
                                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white"
                                />
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-1">Risque par trade (%)</label>
                            <input
                                type="number"
                                id="riskPerTrade"
                                value="2"
                                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white"
                            />
                        </div>

                        <div class="flex space-x-2 mt-6">
                            <button
                                id="runSimulationBtn"
                                class="flex-1 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg flex items-center justify-center"
                            >
                                ‚ñ∂Ô∏è Lancer Simulation
                            </button>
                            
                            <button
                                id="resetBtn"
                                class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg"
                            >
                                üîÑ
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- R√©sultats de la simulation -->
            <div id="simulationResults" class="mt-6 bg-gray-800 rounded-lg p-6 hidden">
                <h2 class="text-xl font-semibold mb-4">üìä R√©sultats de la Simulation</h2>
                
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                    <div class="bg-gray-700 rounded-lg p-4">
                        <div class="text-sm text-gray-400">Nombre de trades</div>
                        <div id="totalTrades" class="text-xl font-bold">--</div>
                    </div>
                    
                    <div class="bg-gray-700 rounded-lg p-4">
                        <div class="text-sm text-gray-400">Taux de r√©ussite</div>
                        <div id="winRate" class="text-xl font-bold text-green-400">--%</div>
                    </div>
                    
                    <div class="bg-gray-700 rounded-lg p-4">
                        <div class="text-sm text-gray-400">Rendement total</div>
                        <div id="totalReturn" class="text-xl font-bold">--%</div>
                    </div>
                    
                    <div class="bg-gray-700 rounded-lg p-4">
                        <div class="text-sm text-gray-400">Drawdown max</div>
                        <div id="maxDrawdown" class="text-xl font-bold text-red-400">--%</div>
                    </div>
                    
                    <div class="bg-gray-700 rounded-lg p-4">
                        <div class="text-sm text-gray-400">Ratio de Sharpe</div>
                        <div id="sharpeRatio" class="text-xl font-bold">--</div>
                    </div>
                    
                    <div class="bg-gray-700 rounded-lg p-4">
                        <div class="text-sm text-gray-400">Facteur de profit</div>
                        <div id="profitFactor" class="text-xl font-bold">--</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let priceChart = null;
        let chartData = [];
        let isSimulating = false;

        // Configuration des cryptos
        const cryptos = {
            'ethereum': { name: 'Ethereum', display: 'ETH', color: '#627EEA' },
            'solana': { name: 'Solana', display: 'SOL', color: '#9945FF' },
            'cardano': { name: 'Cardano', display: 'ADA', color: '#0033AD' },
            'pepe': { name: 'Pepe', display: 'PEPE', color: '#4CAF50' },
            'dogwifcoin': { name: 'Dogwifhat', display: 'WIF', color: '#FF6B35' }
        };

        // Initialisation du graphique
        function initChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Prix',
                        data: [],
                        borderColor: '#627EEA',
                        backgroundColor: 'rgba(98, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#E5E7EB'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#6B7280' },
                            grid: { color: '#374151' }
                        },
                        y: {
                            ticks: { color: '#6B7280' },
                            grid: { color: '#374151' }
                        }
                    }
                }
            });
        }

        // R√©cup√©ration des donn√©es crypto
        async function fetchCryptoData(cryptoId, interval = 'h1') {
            const loadingEl = document.getElementById('loadingIndicator');
            const errorEl = document.getElementById('errorMessage');
            
            loadingEl.classList.remove('hidden');
            errorEl.classList.add('hidden');

            try {
                // Prix actuel
                const priceResponse = await fetch(`https://api.coincap.io/v2/assets/${cryptoId}`);
                if (!priceResponse.ok) throw new Error(`Erreur API: ${priceResponse.status}`);
                
                const priceData = await priceResponse.json();
                const currentPrice = parseFloat(priceData.data.priceUsd);

                // Historique
                const historyResponse = await fetch(
                    `https://api.coincap.io/v2/assets/${cryptoId}/history?interval=${interval}&start=${Date.now() - 24 * 60 * 60 * 1000}&end=${Date.now()}`
                );
                
                if (!historyResponse.ok) throw new Error(`Erreur historique: ${historyResponse.status}`);
                
                const historyData = await historyResponse.json();
                
                // Formatage des donn√©es
                const formattedData = historyData.data.map(point => ({
                    time: new Date(point.time).toLocaleTimeString('fr-FR', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    }),
                    price: parseFloat(point.priceUsd)
                }));

                // Mise √† jour du dernier prix
                if (formattedData.length > 0) {
                    formattedData[formattedData.length - 1].price = currentPrice;
                }

                updateChart(formattedData, cryptoId);
                updatePriceDisplay(currentPrice, cryptoId);
                
            } catch (error) {
                console.error('Erreur:', error);
                showError(`Impossible de r√©cup√©rer les donn√©es: ${error.message}`);
                generateFallbackData(cryptoId);
            } finally {
                loadingEl.classList.add('hidden');
            }
        }

        // Mise √† jour du graphique
        function updateChart(data, cryptoId) {
            const crypto = cryptos[cryptoId];
            const labels = data.map(d => d.time);
            const prices = data.map(d => d.price);

            priceChart.data.labels = labels;
            priceChart.data.datasets[0].data = prices;
            priceChart.data.datasets[0].borderColor = crypto.color;
            priceChart.data.datasets[0].backgroundColor = crypto.color + '20';
            priceChart.update();

            chartData = data;
        }

        // Mise √† jour de l'affichage du prix
        function updatePriceDisplay(price, cryptoId) {
            const crypto = cryptos[cryptoId];
            const priceEl = document.getElementById('currentPrice');
            const labelEl = document.getElementById('cryptoLabel');
            
            let formattedPrice;
            if (cryptoId.includes('pepe')) {
                formattedPrice = price.toFixed(8);
            } else if (cryptoId.includes('cardano') || cryptoId.includes('dogwifcoin')) {
                formattedPrice = price.toFixed(4);
            } else {
                formattedPrice = price.toFixed(2);
            }

            priceEl.textContent = `$${formattedPrice}`;
            priceEl.style.color = crypto.color;
            labelEl.textContent = `${crypto.display}/USD`;
            
            document.getElementById('lastUpdate').textContent = 
                `Derni√®re mise √† jour: ${new Date().toLocaleTimeString('fr-FR')}`;
        }

        // Affichage d'erreur
        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            const errorTextEl = document.getElementById('errorText');
            
            errorTextEl.textContent = message;
            errorEl.classList.remove('hidden');
        }

        // Donn√©es de fallback
        function generateFallbackData(cryptoId) {
            const basePrice = cryptoId.includes('ethereum') ? 3000 : 
                             cryptoId.includes('solana') ? 140 : 
                             cryptoId.includes('cardano') ? 0.45 : 
                             cryptoId.includes('pepe') ? 0.000012 : 2.5;
            
            const data = [];
            for (let i = 0; i < 24; i++) {
                const price = basePrice * (1 + (Math.random() - 0.5) * 0.05);
                data.push({
                    time: new Date(Date.now() - (24 - i) * 60 * 60 * 1000).toLocaleTimeString('fr-FR', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    }),
                    price: price
                });
            }

            updateChart(data, cryptoId);
            updatePriceDisplay(data[data.length - 1].price, cryptoId);
        }

        // Simulation de backtesting
        function runSimulation() {
            const btn = document.getElementById('runSimulationBtn');
            const resultsEl = document.getElementById('simulationResults');
            
            isSimulating = true;
            btn.innerHTML = 'üîÑ Simulation en cours...';
            btn.disabled = true;

            setTimeout(() => {
                // R√©sultats simul√©s
                const results = {
                    totalTrades: Math.floor(Math.random() * 50) + 20,
                    winRate: Math.random() * 40 + 40,
                    totalReturn: (Math.random() - 0.3) * 200,
                    maxDrawdown: Math.random() * 30 + 10,
                    sharpeRatio: Math.random() * 2 + 0.5,
                    profitFactor: Math.random() * 2 + 0.8
                };

                // Affichage des r√©sultats
                document.getElementById('totalTrades').textContent = results.totalTrades;
                document.getElementById('winRate').textContent = `${results.winRate.toFixed(1)}%`;
                
                const returnEl = document.getElementById('totalReturn');
                const returnIcon = results.totalReturn >= 0 ? 'üìà' : 'üìâ';
                const returnColor = results.totalReturn >= 0 ? 'text-green-400' : 'text-red-400';
                returnEl.innerHTML = `${returnIcon} ${results.totalReturn.toFixed(1)}%`;
                returnEl.className = `text-xl font-bold ${returnColor}`;
                
                document.getElementById('maxDrawdown').textContent = `-${results.maxDrawdown.toFixed(1)}%`;
                document.getElementById('sharpeRatio').textContent = results.sharpeRatio.toFixed(2);
                
                const profitEl = document.getElementById('profitFactor');
                profitEl.textContent = results.profitFactor.toFixed(2);
                profitEl.className = `text-xl font-bold ${results.profitFactor >= 1 ? 'text-green-400' : 'text-red-400'}`;

                resultsEl.classList.remove('hidden');
                
                btn.innerHTML = '‚ñ∂Ô∏è Lancer Simulation';
                btn.disabled = false;
                isSimulating = false;
            }, 3000);
        }

        // Reset simulation
        function resetSimulation() {
            document.getElementById('simulationResults').classList.add('hidden');
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // V√©rifier que Chart.js est charg√©
            if (typeof Chart === 'undefined') {
                console.error('Chart.js non charg√©');
                showError('Erreur de chargement des graphiques');
                return;
            }
            
            initChart();
            
            // Chargement initial
            fetchCryptoData('ethereum', 'h1');

            // Event listeners
            document.getElementById('cryptoSelect').addEventListener('change', function() {
                const timeframe = document.getElementById('timeframeSelect').value;
                fetchCryptoData(this.value, timeframe);
            });

            document.getElementById('timeframeSelect').addEventListener('change', function() {
                const crypto = document.getElementById('cryptoSelect').value;
                fetchCryptoData(crypto, this.value);
            });

            document.getElementById('refreshBtn').addEventListener('click', function() {
                const crypto = document.getElementById('cryptoSelect').value;
                const timeframe = document.getElementById('timeframeSelect').value;
                fetchCryptoData(crypto, timeframe);
            });

            document.getElementById('runSimulationBtn').addEventListener('click', runSimulation);
            document.getElementById('resetBtn').addEventListener('click', resetSimulation);

            // Auto-refresh toutes les 30 secondes
            setInterval(() => {
                if (!isSimulating) {
                    const crypto = document.getElementById('cryptoSelect').value;
                    const timeframe = document.getElementById('timeframeSelect').value;
                    fetchCryptoData(crypto, timeframe);
                }
            }, 30000);
        });
    </script>
</body>
</html>
